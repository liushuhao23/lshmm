#!/usr/bin/env node
const Printer = require('@darkobits/lolcatjs');
const figlet = require('figlet');
const prograrm = require('commander');
const inquirer = require('inquirer');
const userHome = require('user-home');
const shell = require('shelljs');
const ora = require('ora');
const download = require('download-git-repo');
const tempUrl = 'direct:https://github.com/liushuhao23/vue-.git';
const fs = require('fs');
const txt = figlet.textSync('LSH_CLI', {
  font: 'Ghost',
  horizontalLayout: 'default',
  width: 80,
  whitespaceBreak: true,
});
prograrm.version(
  Printer.default.fromString(txt) + '\n' + 'æ³½å“¥æ•™æˆ‘å†™çš„è„šæ‰‹æž¶',
  '-v,--version'
);

prograrm.option('-i,--init', 'ðŸ¶ åˆå§‹åŒ–é¡¹ç›®');

const downloadPromise = function (spinner, _dirname, _projectPath) {
  return new Promise((r, j) => {
    download(tempUrl, _projectPath, { clone: true }, (err) => {
      spinner.stop();
      console.log(err, ';');
      if (err) {
        console.log('cli æœåŠ¡å¯åŠ¨å¤±è´¥ï¼Œ');
        j('cli æœåŠ¡å¯åŠ¨å¤±è´¥');
      } else {
        shell.sed('-i', 'vue2', _dirname, _projectPath + '/package.json');
        r(true);
      }
    });
  });
};

const finaly = function () {
  const _dirname = answers.dirname;
  if (_dirname) {
    const spinner = ora('â°, download template');
    spinner.start();
    const _pwd = shell.pwd().stdout;
    const _projectPath = `${_pwd}/${_dirname}`;
    shell.cd(_pwd);
    shell.rm('-rf', _projectPath);
    shell.mkdir(_dirname);
    const downResult = downloadPromise(spinner, _dirname, _projectPath);
    downResult.catch((err) => console.log(err, 'err'));
    // let data = fs.readFileSync( `${_projectPath}/package.json`, 'utf8').split(/\r\n|\n|\r/gm);
    // const appendArr = [
    //   '    "less": "^3.0.4",',
    //   '    "less-loader": "^5.0.0",',
    // ];
    // data.splice(data.length - 5, 0, ...appendArr);
    // fs.writeFileSync(`${_projectPath}/package.json`, data.join('\r\n'))
  }
};
const rely = async function (data) {
  let { rely } = await inquirer.prompt([
    {
      type: 'checkbox',
      message:
        'è¯·é€‰æ‹©ä½ éœ€è¦çš„é¡¹ç›®ä¾èµ–',
      name: 'rely',
      choices: [
        {
          name: 'vue ç‰ˆæœ¬',
          checked: true, // é»˜è®¤é€‰ä¸­
          value: 'versions'
        },
        {
          name: 'babel',
          checked: true, // é»˜è®¤é€‰ä¸­
          value: 'babel'
        },
        {
          name: 'TypeScript',
          value: 'TypeScript'
        },
        {
          name: 'Router',
          value: 'Router'
        },
        {
          name: 'Vuex',
          value: 'Vuex'
        },
        {
          name: 'CSS Pre-processors',
          value: 'CSS'
        },
        {
          name: 'Linter / Formatter',
          value: 'Linter'
        },
      ],
    },
    // {
    //   type: 'list',
    //   message: 'è¯·é€‰æ‹©css Pre-processors',
    //   choices: ['âˆš less', 'âˆš Sass/SCSS (with dart-sass)', 'âˆš Sass/SCSS (with node-sass)', 'âˆš Stylus'],
    //   name: 'PreProcessors',
    // },
  ]);
  console.log(data, 'data');
  console.log(rely, 'rely');
};

const versions = async function(data) {
  let { version } = await inquirer.prompt([
    {
      type: 'list',
      message: 'è¯·é€‰æ‹©vue è¯­è¨€ç‰ˆæœ¬',
      choices: [
        {
          name: 'âˆš vue2 åŸºç¡€æ¨¡æ¿',
          value: 'vue2'
        },
        {
          name: 'âˆš vue3 åŸºç¡€æ¨¡æ¿',
          value: 'vue3'
        }],
      name: 'version',
    },
    // {
    //   type: 'list',
    //   message: 'è¯·é€‰æ‹©css Pre-processors',
    //   choices: ['âˆš less', 'âˆš Sass/SCSS (with dart-sass)', 'âˆš Sass/SCSS (with node-sass)', 'âˆš Stylus'],
    //   name: 'PreProcessors',
    // },
  ]);
  rely({
    dirname: data,
    version
  })
}
const fileName = async function () {
  let {dirname } = await inquirer.prompt([
      {
        type: 'text',
        message: 'è¯·è¾“å…¥æ–‡ä»¶åç§°',
        name: 'dirname',
      },
      // {
      //   type: 'list',
      //   message: 'è¯·é€‰æ‹©css Pre-processors',
      //   choices: ['âˆš less', 'âˆš Sass/SCSS (with dart-sass)', 'âˆš Sass/SCSS (with node-sass)', 'âˆš Stylus'],
      //   name: 'PreProcessors',
      // },
    ])
    if (dirname) {
      versions({dirname})
    } else {
      console.log('è¯·è¾“å…¥æ–‡ä»¶åç§°');
    }
};
const bandHandler = {
  init: () => {
    fileName();
  },
};
prograrm
  .usage('<cmd> [env]')
  .arguments('<cmd> [env]')
  .action(function (cmd, otherParms) {
    const hander = bandHandler[cmd];
    if (hander) {
      hander(otherParms);
    } else {
      console.log('æš‚æœªå®žçŽ°' + cmd);
    }
  });

prograrm.parse(process.argv);
